<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiffy AI - Secure Access</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Orbitron', 'sans-serif'],
                        mono: ['Roboto Mono', 'monospace'],
                    },
                    colors: {
                        'primary-blue': '#6A76FF',
                        'secondary-pink': '#FF6AC1',
                        'dark-bg': '#0D0E1F',
                        'card-bg': 'rgba(25, 29, 58, 0.7)',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;800&family=Roboto+Mono:wght@400&display=swap');

        body {
            font-family: 'Orbitron', sans-serif;
            color: #E2E8F0;
            background: #0D0E1F;
            overflow: hidden;
            position: relative;
        }

        .bg-stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(circle, #E2E8F0 1px, transparent 1px);
            background-size: 15px 15px;
            animation: move-stars 200s linear infinite;
        }

        @keyframes move-stars {
            from { background-position: 0 0; }
            to { background-position: 10000px 5000px; }
        }
        
        .auth-container {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border-radius: 2rem;
            border: 1px solid rgba(106, 118, 255, 0.2);
            box-shadow: 0 0 20px rgba(106, 118, 255, 0.3), 0 0 40px rgba(255, 106, 193, 0.2);
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .auth-container:hover {
            box-shadow: 0 0 30px rgba(106, 118, 255, 0.5), 0 0 60px rgba(255, 106, 193, 0.4);
            transform: translateY(-5px);
        }

        .title-glow {
            text-shadow: 0 0 8px #4D41FF, 0 0 16px #FF41C0;
        }

        .button-primary {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            background: linear-gradient(90deg, #4D41FF, #FF41C0);
            background-size: 200% 100%;
        }

        .button-primary:hover {
            background-position: 100% 0;
            box-shadow: 0 0 10px #4D41FF, 0 0 20px #FF41C0;
            transform: scale(1.05);
        }

        .button-secondary {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            background: linear-gradient(90deg, #FF41C0, #4D41FF);
            background-size: 200% 100%;
        }

        .button-secondary:hover {
            background-position: 100% 0;
            box-shadow: 0 0 10px #FF41C0, 0 0 20px #4D41FF;
            transform: scale(1.05);
        }

        #message-box {
            animation: pulse-glow 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 255, 255, 0.2); }
            50% { box-shadow: 0 0 10px rgba(255, 255, 255, 0.5); }
        }
    </style>
</head>
<body class="text-white flex items-center justify-center min-h-screen p-4 relative font-sans">

    <div class="bg-stars z-0"></div>

    <div class="auth-container bg-card-bg p-8 md:p-12 rounded-2xl w-full max-w-sm text-center relative z-10">
        
        <div class="mb-8">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-16 h-16 mx-auto text-primary-blue mb-4 animate-pulse">
                <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm-2.625 7.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm4.875 0a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM9 17.25c.414 0 .75-.336.75-.75s-.336-.75-.75-.75-.75.336-.75.75.336.75.75.75Zm6-1.5c-.414 0-.75.336-.75.75s.336.75.75.75.75-.336.75-.75-.336-.75-.75-.75Zm-.75-7.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM9 9.75a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM7.5 15a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM16.5 15a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Z" clip-rule="evenodd" />
            </svg>
            <h1 class="text-5xl font-extrabold tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-primary-blue to-secondary-pink title-glow">
                Tiffy AI
            </h1>
            <p class="mt-2 text-sm text-gray-400 font-mono">Quantum Access Node</p>
        </div>

        <div id="message-box" class="bg-gray-900/50 p-4 rounded-xl text-center mb-6 transition-all duration-300 ease-in-out font-mono text-sm border border-gray-700">
            <p id="message-text" class="text-white"></p>
        </div>

        <div id="auth-ui" class="space-y-4">
            </div>

        <p class="mt-8 text-xs text-gray-600 font-mono">
            This system uses your device's passkey for zero-knowledge authentication.
            <br>
            A secure credential is encrypted on this device.
        </p>
        
        <div id="reset-link-container" class="mt-4 hidden">
            <button id="reset-link" class="text-xs text-gray-600 hover:text-gray-400 transition-colors font-mono" onclick="resetPasskey()">
                Clear Device Access
            </button>
        </div>
    </div>

    <script>
        const USER_ID = 'user_demo_123';
        const RP_ID = window.location.hostname;
        const RP_NAME = 'Tiffy AI';
        const TIMEOUT_SECONDS = 30;
        
        let timeoutId = null;

        const base64urlToArrayBuffer = (base64url) => {
            const padding = '='.repeat((4 - base64url.length % 4) % 4);
            const base64 = (base64url + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray.buffer;
        };

        const arrayBufferToBase64url = (arrayBuffer) => {
            const byteArray = new Uint8Array(arrayBuffer);
            let byteString = '';
            for (let i = 0; i < byteArray.byteLength; i++) {
                byteString += String.fromCharCode(byteArray[i]);
            }
            return window.btoa(byteString).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        };

        const showMessage = (message, color = 'text-white') => {
            const messageText = document.getElementById('message-text');
            messageText.textContent = message;
            messageText.className = color;
        };

        const renderUI = () => {
            const authUI = document.getElementById('auth-ui');
            const resetLinkContainer = document.getElementById('reset-link-container');
            const passkeyExists = localStorage.getItem('passkeyId');
            authUI.innerHTML = '';
            resetLinkContainer.classList.add('hidden'); // Hide by default

            if (!passkeyExists) {
                showMessage('No access credential found. Please initialize.', 'text-white');
                const setupButton = document.createElement('button');
                setupButton.textContent = 'Initialize Passkey';
                setupButton.className = 'w-full px-4 py-3 text-white rounded-xl shadow-lg font-bold button-primary';
                setupButton.onclick = setupPasskey;
                authUI.appendChild(setupButton);
            } else {
                showMessage('Authenticate with your secure passkey.', 'text-white');
                const authButton = document.createElement('button');
                authButton.textContent = 'Authorize Access';
                authButton.className = 'w-full px-4 py-3 text-white rounded-xl shadow-lg font-bold button-secondary';
                authButton.onclick = authenticate;
                authUI.appendChild(authButton);
                
                resetLinkContainer.classList.remove('hidden'); // Show the reset link if a passkey exists
            }
        };

        const setupPasskey = async () => {
            if (!window.PublicKeyCredential) {
                showMessage('WebAuthn is not supported on this browser.', 'text-red-400');
                return;
            }

            try {
                showMessage('Initializing secure credential...', 'text-white');
                const challenge = new Uint8Array(32);
                window.crypto.getRandomValues(challenge);

                const credentialCreationOptions = {
                    publicKey: {
                        challenge: challenge,
                        rp: { id: RP_ID, name: RP_NAME },
                        user: { id: new TextEncoder().encode(USER_ID), name: USER_ID, displayName: USER_ID },
                        pubKeyCredParams: [{ type: 'public-key', alg: -7 }, { type: 'public-key', alg: -257 }],
                        authenticatorSelection: { authenticatorAttachment: 'platform', userVerification: 'required', residentKey: 'required' },
                        timeout: 60000,
                    }
                };
                const credential = await navigator.credentials.create(credentialCreationOptions);
                const credentialId = arrayBufferToBase64url(credential.rawId);
                localStorage.setItem('passkeyId', credentialId);
                showMessage('Passkey initialized. Ready for access.', 'text-green-400');
                setTimeout(() => {
                    renderUI();
                }, 1000);

            } catch (error) {
                showMessage(`Initialization failed: ${error.message}`, 'text-red-400');
            }
        };

        const authenticate = async () => {
            if (!window.PublicKeyCredential) {
                showMessage('WebAuthn is not supported on this browser.', 'text-red-400');
                return;
            }

            try {
                showMessage('Requesting authorization...', 'text-white');
                clearTimeout(timeoutId);
                const passkeyId = localStorage.getItem('passkeyId');

                if (!passkeyId) {
                    showMessage('Credential not found. Please initialize.', 'text-red-400');
                    renderUI();
                    return;
                }

                const challenge = new Uint8Array(32);
                window.crypto.getRandomValues(challenge);

                const credentialRequestOptions = {
                    publicKey: {
                        challenge: challenge,
                        rpId: RP_ID,
                        allowCredentials: [{ type: 'public-key', id: base64urlToArrayBuffer(passkeyId) }],
                        userVerification: 'required',
                        timeout: 60000,
                    }
                };

                const credential = await navigator.credentials.get(credentialRequestOptions);
                showMessage('Access granted. Redirecting...', 'text-green-400');
                
                // Redirect to the dashboard page
                window.location.href = 'home_dashboard.html';

            } catch (error) {
                showMessage(`Authorization denied: ${error.message}`, 'text-red-400');
                startAutoLockTimer();
            }
        };

        const startAutoLockTimer = () => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                showMessage('Session terminated. Re-authenticate for access.', 'text-white');
                renderUI();
            }, TIMEOUT_SECONDS * 1000);
        };

        const resetPasskey = () => {
            localStorage.removeItem('passkeyId');
            showMessage('Device access revoked. Please refresh to re-initialize.', 'text-yellow-400');
            clearTimeout(timeoutId);
            renderUI();
        };

        document.addEventListener('DOMContentLoaded', () => {
            renderUI();
        });
    </script>

</body>
</html>
