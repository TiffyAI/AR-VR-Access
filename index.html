<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tiffy AI Unlock</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0a0a0f, #1a1a2e);
    }

    /* subtle animated glow in background */
    body::before {
      content: "";
      position: absolute;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, rgba(77,65,255,0.1), transparent 70%);
      animation: pulseGlow 6s infinite alternate;
      z-index: 0;
    }
    @keyframes pulseGlow {
      from { opacity: 0.3; }
      to { opacity: 0.7; }
    }

    .auth-container {
      position: relative;
      z-index: 1;
      padding: 2rem;
      border-radius: 1.25rem;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(14px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 40px rgba(77, 65, 255, 0.4);
      width: 90%;
      max-width: 400px;
      text-align: center;
      color: white;
    }

    .logo {
      font-size: 2.2rem;
      font-weight: 800;
      color: #4D7CFF;
      text-shadow: 0 0 15px rgba(77, 124, 255, 0.7);
    }

    #message-box {
      margin-top: 1rem;
      margin-bottom: 1rem;
      padding: 0.8rem;
      border-radius: 0.75rem;
      background: rgba(255, 255, 255, 0.08);
      font-size: 0.9rem;
    }

    .btn {
      width: 100%;
      padding: 0.9rem;
      margin-top: 1rem;
      border-radius: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      color: white;
      background: linear-gradient(90deg, #4D41FF, #6D61FF);
      box-shadow: 0 0 20px rgba(77, 65, 255, 0.6);
      transition: all 0.3s;
    }
    .btn:hover {
      background: linear-gradient(90deg, #5D51FF, #7D71FF);
      box-shadow: 0 0 35px rgba(77, 65, 255, 0.9);
      transform: translateY(-2px);
    }

    .reset-btn {
      background: transparent;
      color: #aaa;
      font-size: 0.8rem;
      box-shadow: none;
    }
    .reset-btn:hover {
      color: white;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <h1 class="logo">TiffyAI</h1>
    <p class="text-sm text-gray-400 mb-2">Secure Unlock</p>

    <div id="message-box">
      <p id="message-text">Please authenticate to continue</p>
    </div>

    <div id="auth-ui"></div>
  </div>

  <script>
    const USER_ID = 'user_demo_123';
    const RP_ID = window.location.hostname;
    const RP_NAME = 'Tiffy AI';
    const TIMEOUT_SECONDS = 30;
    let timeoutId = null;

    const base64urlToArrayBuffer = (base64url) => {
      const padding = '='.repeat((4 - base64url.length % 4) % 4);
      const base64 = (base64url + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray.buffer;
    };

    const arrayBufferToBase64url = (arrayBuffer) => {
      const byteArray = new Uint8Array(arrayBuffer);
      let byteString = '';
      for (let i = 0; i < byteArray.byteLength; i++) {
        byteString += String.fromCharCode(byteArray[i]);
      }
      return window.btoa(byteString).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    };

    const showMessage = (message, color = 'text-white') => {
      const messageText = document.getElementById('message-text');
      messageText.textContent = message;
      messageText.className = color;
    };

    const renderUI = () => {
      const authUI = document.getElementById('auth-ui');
      const passkeyExists = localStorage.getItem('passkeyId');
      authUI.innerHTML = '';

      if (!passkeyExists) {
        showMessage('No passkey found. Please set one up.', 'text-gray-200');
        const setupButton = document.createElement('button');
        setupButton.textContent = 'Set Up Passkey';
        setupButton.className = 'btn';
        setupButton.onclick = setupPasskey;
        authUI.appendChild(setupButton);
      } else {
        showMessage('Authenticate with your passkey.', 'text-gray-200');
        const authButton = document.createElement('button');
        authButton.textContent = 'Unlock with Fingerprint';
        authButton.className = 'btn';
        authButton.onclick = authenticate;
        authUI.appendChild(authButton);

        const resetButton = document.createElement('button');
        resetButton.textContent = 'Reset Passkey';
        resetButton.className = 'btn reset-btn';
        resetButton.onclick = resetPasskey;
        authUI.appendChild(resetButton);
      }
    };

    const setupPasskey = async () => {
      try {
        showMessage('Preparing passkey setup...');
        const challenge = new Uint8Array(32);
        crypto.getRandomValues(challenge);

        const credential = await navigator.credentials.create({
          publicKey: {
            challenge,
            rp: { id: RP_ID, name: RP_NAME },
            user: {
              id: new TextEncoder().encode(USER_ID),
              name: USER_ID,
              displayName: USER_ID,
            },
            pubKeyCredParams: [
              { type: 'public-key', alg: -7 },
              { type: 'public-key', alg: -257 },
            ],
            authenticatorSelection: {
              authenticatorAttachment: 'platform',
              userVerification: 'required',
              residentKey: 'required',
            },
            timeout: 60000,
          }
        });

        const credentialId = arrayBufferToBase64url(credential.rawId);
        localStorage.setItem('passkeyId', credentialId);
        showMessage('Passkey created! Now unlock.', 'text-green-400');
        setTimeout(renderUI, 1000);
      } catch (error) {
        showMessage(`Setup failed: ${error.message}`, 'text-red-400');
      }
    };

    const authenticate = async () => {
      try {
        showMessage('Authenticating...');
        clearTimeout(timeoutId);
        const passkeyId = localStorage.getItem('passkeyId');
        if (!passkeyId) return renderUI();

        const challenge = new Uint8Array(32);
        crypto.getRandomValues(challenge);

        await navigator.credentials.get({
          publicKey: {
            challenge,
            rpId: RP_ID,
            allowCredentials: [{ type: 'public-key', id: base64urlToArrayBuffer(passkeyId) }],
            userVerification: 'required',
            timeout: 60000,
          }
        });

        showMessage('✅ Authentication successful!', 'text-green-400');
        setTimeout(() => {
          window.location.href = "https://www.tiffy.ai/play"; // ✅ redirect works here
        }, 1000);

        startAutoLockTimer();
      } catch (error) {
        showMessage(`Auth failed: ${error.message}`, 'text-red-400');
        startAutoLockTimer();
      }
    };

    const startAutoLockTimer = () => {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => {
        showMessage('Session expired. Please authenticate again.');
        renderUI();
      }, TIMEOUT_SECONDS * 1000);
    };

    const resetPasskey = () => {
      localStorage.removeItem('passkeyId');
      showMessage('Passkey reset. Please refresh.', 'text-yellow-400');
      clearTimeout(timeoutId);
      renderUI();
    };

    document.addEventListener('DOMContentLoaded', renderUI);
  </script>
</body>
</html>
