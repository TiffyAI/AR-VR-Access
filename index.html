<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TiffyAI Secure Lock</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the passkey system with a futuristic look */
        body {
            font-family: 'Orbitron', sans-serif;
        }
        
        /* Basic animation for the lock icon */
        @keyframes spin-lock {
            from { transform: rotateY(0deg); }
            to { transform: rotateY(360deg); }
        }
        .lock-icon-spin {
            animation: spin-lock 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Animation for a successful unlock */
        @keyframes unlock-glow {
            from { box-shadow: 0 0 15px rgba(255, 255, 255, 0.5); }
            to { box-shadow: 0 0 50px rgba(0, 255, 0, 0.8); }
        }
        .success-glow {
            animation: unlock-glow 1s ease-in-out forwards;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

    <!-- Main container for the lock interface -->
    <div class="flex flex-col items-center justify-center p-8 bg-gray-800 rounded-2xl shadow-2xl space-y-8 w-full max-w-sm border-2 border-purple-700 bg-opacity-70 transition-all duration-500">
        
        <!-- Header and title -->
        <div class="text-center space-y-2">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500">TiffyAI Secure Access</h1>
            <p class="text-gray-400" id="header-text">Authenticating...</p>
        </div>

        <!-- Lock icon, styled as a visual element -->
        <div class="relative p-6 rounded-full bg-gray-700 transition-colors duration-300 shadow-lg border border-purple-500">
            <!-- SVG for a modern lock icon -->
            <svg class="w-16 h-16 text-purple-400 lock-icon-spin" id="lock-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 1L4 5v6c0 5.55 3.84 10.74 9 12a15.02 15.02 0 005-2.26V9h-2V7h2V5.5c0-1.93-1.57-3.5-3.5-3.5S12 2.57 12 4.5V6H8v2h4v2h2v-2h2v-2h-2V4.5c0-1.93-1.57-3.5-3.5-3.5z"/>
            </svg>
        </div>

        <!-- Dynamic UI for Passkey Management -->
        <div id="auth-ui" class="w-full space-y-4">
            <!-- This content will be dynamically updated by JavaScript -->
        </div>

        <!-- Message Box -->
        <div id="message-box" class="bg-gray-700 p-4 rounded-xl text-center transition-all duration-300 ease-in-out transform w-full">
            <p id="message-text" class="text-white text-sm"></p>
        </div>

        <!-- Acknowledgment for the user about the functionality -->
        <p class="mt-8 text-xs text-gray-400">
            This app uses your device's passkey for secure, passwordless authentication.
            <br>
            A unique credential will be stored locally on this device.
        </p>
    </div>

    <script>
        // Use a random user ID for demonstration purposes. In a real application, this would come from a server.
        const USER_ID = 'user_demo_123';
        const RP_ID = window.location.hostname; // Relying Party ID is the domain
        const RP_NAME = 'Tiffy AI';
        const TIMEOUT_SECONDS = 30; // Auto-lock timeout
        
        let timeoutId = null;

        /**
         * Converts a Base64URL string to an ArrayBuffer.
         * @param {string} base64url The Base64URL string.
         * @returns {ArrayBuffer} The decoded ArrayBuffer.
         */
        const base64urlToArrayBuffer = (base64url) => {
            const padding = '='.repeat((4 - base64url.length % 4) % 4);
            const base64 = (base64url + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray.buffer;
        };

        /**
         * Converts an ArrayBuffer to a Base64URL string.
         * @param {ArrayBuffer} arrayBuffer The ArrayBuffer to encode.
         * @returns {string} The Base64URL string.
         */
        const arrayBufferToBase64url = (arrayBuffer) => {
            const byteArray = new Uint8Array(arrayBuffer);
            let byteString = '';
            for (let i = 0; i < byteArray.byteLength; i++) {
                byteString += String.fromCharCode(byteArray[i]);
            }
            return window.btoa(byteString).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        };

        /**
         * Displays a message in the message box.
         * @param {string} message The message to display.
         * @param {string} color The Tailwind color class for the text.
         */
        const showMessage = (message, color = 'text-white') => {
            const messageText = document.getElementById('message-text');
            messageText.textContent = message;
            messageText.className = color;
        };

        /**
         * Dynamically renders the UI based on whether a passkey exists.
         */
        const renderUI = () => {
            const authUI = document.getElementById('auth-ui');
            const passkeyExists = localStorage.getItem('passkeyId');

            // Clear any existing UI
            authUI.innerHTML = '';

            if (!passkeyExists) {
                // Render setup button if no passkey is found
                showMessage('No passkey found. Please set one up.', 'text-white');
                const setupButton = document.createElement('button');
                setupButton.textContent = 'Set Up Passkey';
                setupButton.className = 'w-full px-4 py-3 bg-purple-600 text-white rounded-xl shadow-lg hover:bg-opacity-90 transition-all duration-300 font-semibold';
                setupButton.onclick = setupPasskey;
                authUI.appendChild(setupButton);
            } else {
                // Render authenticate button if a passkey exists
                showMessage('Authenticate with your passkey.', 'text-white');
                const authButton = document.createElement('button');
                authButton.textContent = 'Unlock with Fingerprint';
                authButton.className = 'w-full px-4 py-3 bg-pink-500 text-white rounded-xl shadow-lg hover:bg-opacity-90 transition-all duration-300 font-semibold';
                authButton.onclick = authenticate;
                authUI.appendChild(authButton);

                const container = document.querySelector('.auth-container');
                container.style.transform = 'translateY(0)';
                container.style.opacity = '1';

                // Add a "logout" or "reset" button for demo purposes
                const resetButton = document.createElement('button');
                resetButton.textContent = 'Reset Passkey';
                resetButton.className = 'mt-4 text-xs text-gray-400 hover:text-white transition-colors';
                resetButton.onclick = resetPasskey;
                authUI.appendChild(resetButton);
            }
        };

        /**
         * Initiates the passkey registration process.
         */
        const setupPasskey = async () => {
            if (!window.PublicKeyCredential) {
                showMessage('WebAuthn is not supported on this browser.', 'text-red-400');
                return;
            }

            try {
                showMessage('Preparing to set up passkey...', 'text-white');

                // Generate a unique challenge for the registration
                const challenge = new Uint8Array(32);
                window.crypto.getRandomValues(challenge);

                const credentialCreationOptions = {
                    publicKey: {
                        challenge: challenge,
                        rp: {
                            id: RP_ID,
                            name: RP_NAME,
                        },
                        user: {
                            id: new TextEncoder().encode(USER_ID),
                            name: USER_ID,
                            displayName: USER_ID,
                        },
                        pubKeyCredParams: [
                            { type: 'public-key', alg: -7 }, // ES256
                            { type: 'public-key', alg: -257 }, // RS256
                        ],
                        authenticatorSelection: {
                            authenticatorAttachment: 'platform',
                            userVerification: 'required',
                            residentKey: 'required',
                        },
                        timeout: 60000,
                    }
                };

                const credential = await navigator.credentials.create(credentialCreationOptions);

                // Successfully created credential. Store the ID locally.
                const credentialId = arrayBufferToBase64url(credential.rawId);
                localStorage.setItem('passkeyId', credentialId);

                showMessage('Passkey created successfully! Now try to unlock.', 'text-green-400');
                
                // Vanish the setup UI after a short delay
                setTimeout(() => {
                    document.querySelector('.auth-container').style.opacity = '0';
                    setTimeout(() => renderUI(), 500);
                }, 1000);

            } catch (error) {
                showMessage(`Passkey setup failed: ${error.message}`, 'text-red-400');
            }
        };

        /**
         * Initiates the passkey authentication process.
         */
        const authenticate = async () => {
            if (!window.PublicKeyCredential) {
                showMessage('WebAuthn is not supported on this browser.', 'text-red-400');
                return;
            }

            try {
                showMessage('Authenticating with passkey...', 'text-white');
                
                // Clear the timeout to prevent auto-lock during authentication
                clearTimeout(timeoutId);

                const passkeyId = localStorage.getItem('passkeyId');

                if (!passkeyId) {
                    showMessage('No passkey found. Please set one up.', 'text-red-400');
                    renderUI();
                    return;
                }

                // Generate a new challenge for authentication
                const challenge = new Uint8Array(32);
                window.crypto.getRandomValues(challenge);

                const credentialRequestOptions = {
                    publicKey: {
                        challenge: challenge,
                        rpId: RP_ID,
                        allowCredentials: [{
                            type: 'public-key',
                            id: base64urlToArrayBuffer(passkeyId),
                        }],
                        userVerification: 'required',
                        timeout: 60000,
                    }
                };

                const credential = await navigator.credentials.get(credentialRequestOptions);

                // Authentication successful
                showMessage('Authentication successful!', 'text-green-400');
                
                // Redirect or perform other actions upon success
                setTimeout(() => {
                    showMessage('Success! Redirecting to main page...', 'text-green-400');
                    // In a real app, this would be a redirect: window.location.href = 'https://www.tiffy.ai/play';
                    window.location.href = 'https://tiffyai.github.io/Play'; // Redirect to /Play
                }, 1000);

                // Start the auto-lock timer
                startAutoLockTimer();

            } catch (error) {
                showMessage(`Authentication failed: ${error.message}`, 'text-red-400');
                // Re-enable the authentication button if the user fails
                startAutoLockTimer();
            }
        };

        /**
         * Starts the auto-lock timer.
         */
        const startAutoLockTimer = () => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                showMessage('Session expired. Please authenticate again.', 'text-white');
                document.querySelector('.auth-container').style.transform = 'translateY(0)';
                document.querySelector('.auth-container').style.opacity = '1';
                renderUI(); // Re-render the UI to show the locked state
            }, TIMEOUT_SECONDS * 1000);
        };

        /**
         * Resets the passkey stored in local storage for demo purposes.
         */
        const resetPasskey = () => {
            localStorage.removeItem('passkeyId');
            showMessage('Passkey reset. Please refresh the page to set up again.', 'text-yellow-400');
            clearTimeout(timeoutId);
            renderUI();
        };

        // Initial check on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderUI();
        });
    </script>

</body>
</html>
