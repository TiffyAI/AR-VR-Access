<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tiffy AI Unlock</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* === Space Gradient Background === */
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Inter', sans-serif;
      background: radial-gradient(circle at top left, #1a1a2e, #0f0f1c 70%);
      overflow: hidden;
    }
    body::before {
      content: "";
      position: absolute;
      width: 200%;
      height: 200%;
      background: conic-gradient(
        from 180deg,
        #4D41FF22,
        #FF41C022,
        #4D41FF22
      );
      animation: spin 20s linear infinite;
      z-index: 0;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* === Stars twinkle === */
    .stars {
      position: absolute;
      width: 100%;
      height: 100%;
      background: transparent url("https://i.ibb.co/7QpKsCX/stars.png") repeat;
      animation: twinkle 100s linear infinite;
      z-index: 0;
    }
    @keyframes twinkle {
      from { background-position: 0 0; }
      to { background-position: -10000px 5000px; }
    }

    /* === Glassmorphism Container === */
    .auth-container {
      position: relative;
      z-index: 1;
      padding: 2rem;
      border-radius: 1.5rem;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 40px rgba(77, 65, 255, 0.5);
      width: 90%;
      max-width: 420px;
      text-align: center;
      color: white;
    }

    /* === Logo === */
    .logo {
      font-size: 2.5rem;
      font-weight: 900;
      background: linear-gradient(90deg, #4D41FF, #FF41C0, #4D41FF);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: shimmer 6s infinite linear;
    }
    @keyframes shimmer {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }

    /* === Buttons === */
    .btn {
      width: 100%;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      position: relative;
      overflow: hidden;
    }
    .btn-blue {
      background: linear-gradient(90deg, #4D41FF, #6D61FF);
      box-shadow: 0 0 15px rgba(77, 65, 255, 0.6);
    }
    .btn-blue:hover {
      background: linear-gradient(90deg, #6D61FF, #8D81FF);
      box-shadow: 0 0 30px rgba(77, 65, 255, 0.9);
      transform: translateY(-2px);
    }
    .btn-pink {
      background: linear-gradient(90deg, #FF41C0, #FF61D5);
      box-shadow: 0 0 15px rgba(255, 65, 192, 0.6);
    }
    .btn-pink:hover {
      background: linear-gradient(90deg, #FF61D5, #FF81E5);
      box-shadow: 0 0 30px rgba(255, 65, 192, 0.9);
      transform: translateY(-2px);
    }

    /* === Message Box === */
    #message-box {
      padding: 0.8rem;
      border-radius: 0.75rem;
      background: rgba(255, 255, 255, 0.1);
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="stars"></div>

  <!-- Unlock Container -->
  <div class="auth-container">
    <h1 class="logo">Tiffy AI</h1>
    <p class="text-sm text-pink-300 mb-4">Space-Age Secure Unlock</p>

    <!-- Messages -->
    <div id="message-box">
      <p id="message-text">Please authenticate to continue</p>
    </div>

    <!-- Dynamic Buttons -->
    <div id="auth-ui"></div>
  </div>

  <script>
    const USER_ID = 'user_demo_123';
    const RP_ID = window.location.hostname;
    const RP_NAME = 'Tiffy AI';
    const TIMEOUT_SECONDS = 30;
    let timeoutId = null;

    const base64urlToArrayBuffer = (base64url) => {
      const padding = '='.repeat((4 - base64url.length % 4) % 4);
      const base64 = (base64url + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray.buffer;
    };

    const arrayBufferToBase64url = (arrayBuffer) => {
      const byteArray = new Uint8Array(arrayBuffer);
      let byteString = '';
      for (let i = 0; i < byteArray.byteLength; i++) {
        byteString += String.fromCharCode(byteArray[i]);
      }
      return window.btoa(byteString).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    };

    const showMessage = (message, color = 'text-white') => {
      const messageText = document.getElementById('message-text');
      messageText.textContent = message;
      messageText.className = color;
    };

    const renderUI = () => {
      const authUI = document.getElementById('auth-ui');
      const passkeyExists = localStorage.getItem('passkeyId');
      authUI.innerHTML = '';

      if (!passkeyExists) {
        showMessage('No passkey found. Please set one up.', 'text-gray-200');
        const setupButton = document.createElement('button');
        setupButton.textContent = 'ðŸš€ Set Up Passkey';
        setupButton.className = 'btn btn-blue';
        setupButton.onclick = setupPasskey;
        authUI.appendChild(setupButton);
      } else {
        showMessage('Authenticate with your passkey.', 'text-gray-200');
        const authButton = document.createElement('button');
        authButton.textContent = 'ðŸ”“ Unlock with Fingerprint';
        authButton.className = 'btn btn-pink';
        authButton.onclick = authenticate;
        authUI.appendChild(authButton);

        const resetButton = document.createElement('button');
        resetButton.textContent = 'Reset Passkey';
        resetButton.className = 'btn text-xs mt-2 text-gray-300 hover:text-white';
        resetButton.onclick = resetPasskey;
        authUI.appendChild(resetButton);
      }
    };

    const setupPasskey = async () => {
      try {
        showMessage('Preparing passkey setup...');
        const challenge = new Uint8Array(32);
        crypto.getRandomValues(challenge);

        const credential = await navigator.credentials.create({
          publicKey: {
            challenge,
            rp: { id: RP_ID, name: RP_NAME },
            user: {
              id: new TextEncoder().encode(USER_ID),
              name: USER_ID,
              displayName: USER_ID,
            },
            pubKeyCredParams: [
              { type: 'public-key', alg: -7 },
              { type: 'public-key', alg: -257 },
            ],
            authenticatorSelection: {
              authenticatorAttachment: 'platform',
              userVerification: 'required',
              residentKey: 'required',
            },
            timeout: 60000,
          }
        });

        const credentialId = arrayBufferToBase64url(credential.rawId);
        localStorage.setItem('passkeyId', credentialId);
        showMessage('Passkey created! Now unlock.', 'text-green-400');
        setTimeout(renderUI, 1000);
      } catch (error) {
        showMessage(`Setup failed: ${error.message}`, 'text-red-400');
      }
    };

    const authenticate = async () => {
      try {
        showMessage('Authenticating...');
        clearTimeout(timeoutId);
        const passkeyId = localStorage.getItem('passkeyId');
        if (!passkeyId) return renderUI();

        const challenge = new Uint8Array(32);
        crypto.getRandomValues(challenge);

        await navigator.credentials.get({
          publicKey: {
            challenge,
            rpId: RP_ID,
            allowCredentials: [{ type: 'public-key', id: base64urlToArrayBuffer(passkeyId) }],
            userVerification: 'required',
            timeout: 60000,
          }
        });

        showMessage('âœ… Authentication successful!', 'text-green-400');
        setTimeout(() => {
          showMessage('Redirecting...', 'text-green-400');
        }, 1000);

        startAutoLockTimer();
      } catch (error) {
        showMessage(`Auth failed: ${error.message}`, 'text-red-400');
        startAutoLockTimer();
      }
    };

    const startAutoLockTimer = () => {
      clearTimeout(timeoutId);
      timeoutId = setTimeout(() => {
        showMessage('Session expired. Please authenticate again.');
        renderUI();
      }, TIMEOUT_SECONDS * 1000);
    };

    const resetPasskey = () => {
      localStorage.removeItem('passkeyId');
      showMessage('Passkey reset. Please refresh.', 'text-yellow-400');
      clearTimeout(timeoutId);
      renderUI();
    };

    document.addEventListener('DOMContentLoaded', renderUI);
  </script>
</body>
</html>
